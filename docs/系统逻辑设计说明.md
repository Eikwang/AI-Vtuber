# 助播流程
## 助播流程是AI-VTUBER系统中最高优先级

- 当助播功能 config.json 1858-1859 开启,并选择了要处理的信息类型 config.json 1862-1875 ,相应类型的信息应由助播指定的tts进行处理,并根据设置 config.json 1940-1940 决定是否将音频转发给DH-LIVVE系统.

# 全局流程
## 这是默认的系统处理流程,经过助播信息类型判断后,不在助播和信息类型范围内的信息由全局流程处理
## 需要进行 config.json 37-37 "visual_body"="metahuman_stream"条件判断

- 当信息类型不包含在助播处理的信息范围内,则属于全局信息,由全局TTS处理,此时需要判断 "visual_body"="metahuman_stream".当条件成立,相应的音频合成&音频播放均由metahuman_stream进行托管处理.

# 全局本地问答功能
## 逻辑说明:全局问答的文本与音频由全局流程处理

- 当全局 本地问答-文本 config.json 610-610 开启,系统收到弹幕comment信息需要进行本地知识库匹配,匹配成功返回知识库内容,由全局流程处理.匹配失败则发送LLM回答.LLM回复的信息由全局流程处理.

- 当全局 本地回答-音频 config.json 616-617 开启,系统收到弹幕信息后会匹配本地音频文件,若匹配成功,则返回音频路径进行直接播放前的条件判断,若助播 config.json 1862-1864 选择了"local_qa_audio"类型信息,此音频由助播流程处理, 否则由全局流程处理(需要经过"visual_body = metahuman_stream" 条件判断,若条件成立,音频发送给metahuman_stream处理).此音频是本地提前准备好了的,匹配成功直播播放.

# 助播本地问答功能
## 逻辑说明:助播问答的文本与音频由助播流程处理

- 当助播 本地问答-文本 config.json 1926-1926 开启,系统收到弹幕信息comment需要同时进行助播知识库匹配,匹配成功返回知识库内容并通过助播流程处理.匹配失败则忽略.即使助播没有选择comment类型,也需要进行助播问答文本匹配.

- 当助播 本地问答-音频 config.json 1930-1931 开启,系统收到弹幕信息,需要进行本地助播音频匹配,若匹配成功,则返回音频路径并通过助播流程处理.若匹配失败则继续下一步流程.即使助播没有选择comment类型,也需要进行助播问答音频匹配,并且匹配成功由助播流程处理.

- 关于助播处理comment类信息的说明:如果助播选择了comment,那么全局问答文本匹配失败后的LLM回复由助播流程处理.如果助播没有选择comment,那么全局问答文本匹配失败后的LLM回复由全局流程处理.

### 优先级说明:助播本地音频 config.json 1931-1932 > 全局本地音频 config.json 616-618 > 助播本地文本 config.json 1926-1928 > 全局本地文本 config.json 609-612 

# 文案流程
## 文案开启后,文案音频直接进入文案音频队列进行播放
## 它不属于全局音频也不属于助播音频.使用独立队列播放.

# 关于音频处理系统audio.py的详细说明
## 它的职能:处理所有AI-VTUBER系统的音频播放(全局TTS合成,助播TTS合成,本地问答音频,助播问答音频.文案音频)
## 设计流程
### 全局流程的处理:
- 全局流程的音频合成与播放均由全局TTS处理,全局TTS处理完成后将音频加入播放队列
- 若"visual_body"="metahuman_stream",则将文本和音频均通过API发送给metahuman_stream处理,metahuman_stream完全托管语音合成和播放等任务.
### 助播流程的处理:
- 助播流程的音频合成与播放均由助播TTS处理,助播TTS处理完成后,判断是否需要转发给DH-LIVE系统
- 若转发DH-LIVE config.json 1939-1940 开启,则进入 dh_live_manager.py 队列组织环节,等待转发DH-LIVE模块处理后进入助播流程队列.
## 播放队列处理流程:
- 音频队列处理流程是一个异步流程,不与主线程冲突
- 它的职能是按照时间顺序对TTS合成的音频进行排序和播放,直接播放的音频则根据处理响应时间插入队列
- 音频分为全局流程/助播流程/文案音频三个不同的类型,分别进入三个不同的队列.这三个队列同时异步处理并独立播放,互不干扰.

# 关于转发DH-LIVE模块 dh_live_manager.py的详细说明
## 它的职能:
- 将助播流程的音频进行队列组织,通过API转发给DH-LIVE系统
- 等待DH-liveAPI响应后再将音频添加到audio..py的助播播放流程.
## 设计流程:
- 1,audio.py接收助播流程音频后,判断是否需要转发给DH-LIVE系统,若关闭转发,则直接加入助播播放队列.
- 2,若开启转发,则进行队列组织环节,将音频通过API发送至dh-live
- 3,等待DH-LIVE 200响应后执行设定的廷迟,廷迟结束将音频加入audio.py助播播放队列.
- 4,添加audio.py播放队列的同时,启动一个计时器,计时的时长为当次转发音频的时长,在这个时间内收到的音频处于队列等待状态,不会进行转发.
- 5,计时结束后再继续转发&添加播放.这样设计的目的是给DH-LIVE留出推理时间,确保口型与音频匹配.
